<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang Quản lý Admin</title>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #eef2f7;
      margin: 0;
      padding: 20px;
    }
    #adminPage {
      opacity: 0;
      max-width: 960px;
      margin: auto;
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    th, td {
      padding: 10px 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    button {
      background-color: #007bff;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      margin: 2px;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    form {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    input, select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      flex: 1 1 150px;
      min-width: 150px;
    }
    #saveButton {
      background-color: #28a745;
      flex: 1 1 100px;
      min-width: 100px;
    }
    #logoutBtn {
      float: right;
      background-color: #dc3545;
    }
  </style>
</head>
<body>
  <div id="adminPage" class="hidden">
    <h1>Quản lý Nhân sự Admin</h1>
    <button id="logoutBtn">Đăng xuất</button>

    <form id="employeeForm" onsubmit="return false;">
      <input type="text" id="id" placeholder="ID" required />
      <input type="text" id="ban" placeholder="Ban" required />
      <input type="text" id="name" placeholder="Tên" required />
      <input type="date" id="dob" placeholder="Ngày sinh" required />
      <select id="process" required>
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
      </select>
      <input type="email" id="email" placeholder="Email" required />
      <input type="text" id="phone" placeholder="Số điện thoại" required />
      <select id="role" required>
        <option value="Member">Member</option>
        <option value="Admin">Admin</option>
      </select>
      <button id="addButton" type="button">Thêm nhân sự</button>
      <button id="saveButton" type="button">Lưu thay đổi</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>ID</th><th>Ban</th><th>Tên</th><th>Ngày sinh</th><th>Process</th><th>Email</th><th>Phone</th><th>Role</th><th>Hành động</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody"></tbody>
    </table>
  </div>

  <!-- Firebase + GSAP + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import gsap from "https://cdn.skypack.dev/gsap";

    const firebaseConfig = {
      apiKey: "AIzaSyDuTvBn8Xl01DYddVXQ7M0L24K3l-GyG0c",
      authDomain: "enactusftuhanoi-tracuu.firebaseapp.com",
      projectId: "enactusftuhanoi-tracuu",
      storageBucket: "enactusftuhanoi-tracuu.appspot.com",
      messagingSenderId: "611356979403",
      appId: "1:611356979403:web:2c9a4cffb2b323ce3deb4e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminPage = document.getElementById("adminPage");
    const employeeTableBody = document.getElementById("employeeTableBody");

    const idInput = document.getElementById("id");
    const banInput = document.getElementById("ban");
    const nameInput = document.getElementById("name");
    const dobInput = document.getElementById("dob");
    const processInput = document.getElementById("process");
    const emailInput = document.getElementById("email");
    const phoneInput = document.getElementById("phone");
    const roleInput = document.getElementById("role");

    const addButton = document.getElementById("addButton");
    const saveButton = document.getElementById("saveButton");
    const logoutBtn = document.getElementById("logoutBtn");

    let editingDocId = null;

    // Kiểm tra quyền admin khi load trang
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Chưa đăng nhập => chuyển về login
        window.location.href = "login.html";
        return;
      }
      // Kiểm tra role trong Firestore
      const q = query(collection(db, "employees"), where("email", "==", user.email));
      const snapshot = await getDocs(q);
      if (snapshot.empty || snapshot.docs[0].data().role !== "Admin") {
        alert("Bạn không có quyền truy cập trang này!");
        await signOut(auth);
        window.location.href = "login.html";
        return;
      }
      // Hiển thị trang admin với hiệu ứng đẹp
      adminPage.classList.remove("hidden");
      gsap.to(adminPage, { opacity: 1, duration: 1, ease: "power2.out" });
      loadEmployees();
    });

    logoutBtn.onclick = async () => {
      await signOut(auth);
      window.location.href = "login.html";
    };

    // Load tất cả nhân sự lên bảng
    async function loadEmployees() {
      employeeTableBody.innerHTML = "";
      const snapshot = await getDocs(collection(db, "employees"));
      snapshot.forEach(docSnap => {
        const emp = docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${emp.id}</td>
          <td>${emp.ban}</td>
          <td>${emp.name}</td>
          <td>${emp.dob}</td>
          <td>${emp.process}</td>
          <td>${emp.email}</td>
          <td>${emp.phone}</td>
          <td>${emp.role}</td>
          <td>
            <button class="editBtn" data-id="${docSnap.id}">Sửa</button>
            <button class="deleteBtn" data-id="${docSnap.id}">Xóa</button>
          </td>
        `;
        employeeTableBody.appendChild(tr);
      });

      // Gắn sự kiện cho nút sửa, xóa
      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.onclick = () => startEdit(btn.dataset.id);
      });
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = () => deleteEmployee(btn.dataset.id);
      });
    }

    // Bắt đầu sửa nhân sự
    async function startEdit(docId) {
      const docRef = doc(db, "employees", docId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return alert("Nhân sự không tồn tại!");

      const emp = docSnap.data();
      editingDocId = docId;
      idInput.value = emp.id;
      banInput.value = emp.ban;
      nameInput.value = emp.name;
      dobInput.value = emp.dob;
      processInput.value = emp.process;
      emailInput.value = emp.email;
      phoneInput.value = emp.phone;
      roleInput.value = emp.role;

      // Ẩn nút thêm, hiện nút lưu
      addButton.style.display = "none";
      saveButton.style.display = "inline-block";
    }

    // Xóa nhân sự
    async function deleteEmployee(docId) {
      if (!confirm("Bạn có chắc muốn xóa nhân sự này?")) return;
      await deleteDoc(doc(db, "employees", docId));
      loadEmployees();
    }

    // Thêm nhân sự mới
    addButton.onclick = async () => {
      const newEmp = getFormData();
      if (!newEmp) return;
      await addDoc(collection(db, "employees"), newEmp);
      clearForm();
      loadEmployees();
    };

    // Lưu thay đổi nhân sự đang sửa
    saveButton.onclick = async () => {
      if (!editingDocId) return alert("Chưa chọn nhân sự để sửa.");
      const newEmp = getFormData();
      if (!newEmp) return;
      const docRef = doc(db, "employees", editingDocId);
      await updateDoc(docRef, newEmp);
      clearForm();
      loadEmployees();
      editingDocId = null;
      addButton.style.display = "inline-block";
      saveButton.style.display = "none";
    };

    // Lấy dữ liệu từ form
    function getFormData() {
      if (
        !idInput.value.trim() ||
        !banInput.value.trim() ||
        !nameInput.value.trim() ||
        !dobInput.value.trim() ||
        !processInput.value.trim() ||
        !emailInput.value.trim() ||
        !phoneInput.value.trim() ||
        !roleInput.value.trim()
      ) {
        alert("Vui lòng điền đầy đủ thông tin.");
        return null;
      }
      return {
        id: idInput.value.trim(),
        ban: banInput.value.trim(),
        name: nameInput.value.trim(),
        dob: dobInput.value,
        process: processInput.value,
        email: emailInput.value.trim(),
        phone: phoneInput.value.trim(),
        role: roleInput.value
      };
    }

    // Xóa sạch form
    function clearForm() {
      idInput.value = "";
      banInput.value = "";
      nameInput.value = "";
      dobInput.value = "";
      processInput.value = "Active";
      emailInput.value = "";
      phoneInput.value = "";
      roleInput.value = "Member";
    }

    // Ẩn nút save lúc đầu
    saveButton.style.display = "none";
  </script>
</body>
</html>
