<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Điểm danh hệ thống</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #adminUI, #memberUI { display: none; }
  </style>
</head>
<body class="bg-gray-100 font-sans p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Hệ thống điểm danh</h1>
      <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white rounded">Đăng xuất</button>
    </div>

    <div id="adminUI">
      <h2 class="text-xl font-semibold mb-4">Giao diện Quản trị viên (Admin)</h2>
      <!-- Form tạo phiên điểm danh -->
      <form id="createSessionForm" class="space-y-4 max-w-md">
        <div>
          <label for="sessionName" class="block font-medium mb-1">Tên phiên điểm danh:</label>
          <input type="text" id="sessionName" required class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label for="startTime" class="block font-medium mb-1">Thời gian bắt đầu:</label>
          <input type="datetime-local" id="startTime" required class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label for="endTime" class="block font-medium mb-1">Thời gian kết thúc:</label>
          <input type="datetime-local" id="endTime" required class="w-full border rounded px-3 py-2" />
        </div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Tạo phiên điểm danh</button>
      </form>
      <p id="adminMsg" class="mt-4 text-green-600"></p>
    </div>

    <div id="memberUI">
      <h2 class="text-xl font-semibold mb-4">Giao diện Thành viên - Điểm danh</h2>
      <p id="attendanceStatus" class="mb-4">Đang kiểm tra phiên điểm danh...</p>
      <button id="checkInBtn" class="bg-green-600 text-white px-4 py-2 rounded" disabled>Điểm danh</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDuTvBn8Xl01DYddVXQ7M0L24K3l-GyG0c",
      authDomain: "enactusftuhanoi-tracuu.firebaseapp.com",
      projectId: "enactusftuhanoi-tracuu",
      storageBucket: "enactusftuhanoi-tracuu.appspot.com",
      messagingSenderId: "611356979403",
      appId: "1:611356979403:web:2c9a4cffb2b323ce3deb4e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Lấy userEmail và userRole từ sessionStorage
    const userEmail = sessionStorage.getItem('userEmail');
    const userRole = sessionStorage.getItem('userRole');

    if (!userEmail || !userRole) {
      alert('Bạn chưa đăng nhập hoặc không có quyền truy cập.');
      window.location.href = "https://enactusftuhanoi.github.io/vn/login.html";
    }

    const adminUI = document.getElementById('adminUI');
    const memberUI = document.getElementById('memberUI');
    const logoutBtn = document.getElementById('logoutBtn');

    // Đăng xuất
    logoutBtn.onclick = () => {
      sessionStorage.clear();
      auth.signOut();
      window.location.href = "https://enactusftuhanoi.github.io/vn/login.html";
    };

    if (userRole.toLowerCase() === "admin") {
      adminUI.style.display = "block";
    } else {
      memberUI.style.display = "block";
      startMemberAttendance();
    }

    // --- Admin tạo phiên điểm danh ---
    const createSessionForm = document.getElementById('createSessionForm');
    const adminMsg = document.getElementById('adminMsg');

    createSessionForm.addEventListener('submit', async e => {
      e.preventDefault();

      const sessionName = document.getElementById('sessionName').value.trim();
      const startTimeStr = document.getElementById('startTime').value;
      const endTimeStr = document.getElementById('endTime').value;

      if (!sessionName || !startTimeStr || !endTimeStr) {
        alert("Vui lòng nhập đầy đủ thông tin!");
        return;
      }

      const startTime = new Date(startTimeStr);
      const endTime = new Date(endTimeStr);

      if (startTime >= endTime) {
        alert("Thời gian bắt đầu phải nhỏ hơn thời gian kết thúc!");
        return;
      }

      try {
        await db.collection("attendance_sessions").add({
          name: sessionName,
          startTime: firebase.firestore.Timestamp.fromDate(startTime),
          endTime: firebase.firestore.Timestamp.fromDate(endTime),
          createdBy: userEmail,
          createdAt: firebase.firestore.Timestamp.now()
        });

        adminMsg.textContent = "Tạo phiên điểm danh thành công!";
        createSessionForm.reset();
      } catch (error) {
        console.error("Lỗi tạo phiên điểm danh:", error);
        adminMsg.textContent = "Lỗi khi tạo phiên điểm danh.";
      }
    });

    // --- Member điểm danh ---
    function startMemberAttendance() {
      const attendanceStatus = document.getElementById('attendanceStatus');
      const checkInBtn = document.getElementById('checkInBtn');

      // Kiểm tra có phiên điểm danh đang diễn ra không
      async function checkActiveSession() {
        attendanceStatus.textContent = "Đang kiểm tra phiên điểm danh...";
        checkInBtn.disabled = true;

        const now = firebase.firestore.Timestamp.now();
        const sessionsRef = db.collection("attendance_sessions");
        const activeQuery = sessionsRef
          .where("startTime", "<=", now)
          .where("endTime", ">=", now);

        try {
          const snapshot = await activeQuery.get();

          if (snapshot.empty) {
            attendanceStatus.textContent = "⏳ Hiện không có phiên điểm danh nào đang diễn ra.";
            checkInBtn.disabled = true;
            return;
          }

          const sessionDoc = snapshot.docs[0];
          const sessionId = sessionDoc.id;

          // Kiểm tra xem user đã điểm danh chưa
          const recordRef = db.collection("attendance_records")
            .where("sessionId", "==", sessionId)
            .where("email", "==", userEmail);

          const recordSnap = await recordRef.get();

          if (!recordSnap.empty) {
            attendanceStatus.textContent = "✅ Bạn đã điểm danh cho phiên này.";
            checkInBtn.disabled = true;
            return;
          }

          attendanceStatus.textContent = "Bạn chưa điểm danh. Nhấn nút để điểm danh.";
          checkInBtn.disabled = false;

          // Xử lý điểm danh khi click
          checkInBtn.onclick = async () => {
            try {
              await db.collection("attendance_records").add({
                sessionId: sessionId,
                email: userEmail,
                name: sessionStorage.getItem('userName') || "Không rõ tên",
                ban: sessionStorage.getItem('userBan') || "Không rõ ban",
                timestamp: firebase.firestore.Timestamp.now()
              });
              attendanceStatus.textContent = "✅ Điểm danh thành công!";
              checkInBtn.disabled = true;
            } catch (error) {
              console.error("Lỗi khi điểm danh:", error);
              attendanceStatus.textContent = "❌ Lỗi khi điểm danh. Vui lòng thử lại.";
            }
          };

        } catch (error) {
          console.error("Lỗi kiểm tra phiên điểm danh:", error);
          attendanceStatus.textContent = "❌ Lỗi khi kiểm tra phiên điểm danh.";
          checkInBtn.disabled = true;
        }
      }

      checkActiveSession();

      // Có thể set interval để check lại sau 1 khoảng thời gian nếu muốn:
      // setInterval(checkActiveSession, 60000);
    }
  </script>
</body>
</html>
